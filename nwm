#! /usr/bin/env bash

dir=`readlink -e $BASH_SOURCE`
dir=`dirname $dir`

nwm_dir="$HOME/.nwm/"

# you probably have a something in your .bashrc to setup node.
# i do, and this makes it work when you run sudo.
# this may not be the best way to tackle this, but it works now, for me.
# post an issue and mention @dominictarr if this breaks something.


start () {
  log=''
  if [ "x$1" = x ]; then
    log='2> "$nwm_dir/nwm.err.log" 1> "$nwm_dir/nwm.log"'
  fi
    node "$dir/nwm-user-sample.js" $log
  exit
}

mkdir -p ~/.nwm


init () {
  NODE=`which node` 
  plat=`uname`
  case $plat in
    Linux)
      cat << NWM1 > $HOME/.nwm/nwm-start
#! /usr/bin/env bash
$NODE "$dir/nwm-user-sample.js" 2> "$nwm_dir/err.log" 1> "$nwm_dir/out.log"

NWM1

      chmod +x "$nwm_dir/nwm-start"

      cat << NWM2 > "$nwm_dir/nwm.desktop"
[Desktop Entry]
Encoding=UTF-8
Name=nwm
Comment=This session starts nwm
Exec=$nwm_dir/nwm-start
Type=Application
NWM2
    ;;
    *)
      echo nwm does not yet have install script for
      echo your platform: $plat. see readme for manual instructions
      exit 1
  esac
  exit
}

#run this command as sudo.
install () {
  plat=`uname`
  case $plat in
    Linux)
      #nwm.desktop is generated by `nwm init`
      cp $nwm_dir/nwm.desktop /usr/share/xsessions/
    ;;
    *)
      echo nwm does not yet have install script for
      echo your platform: $plat. see readme for manual instructions
      exit 1
  esac
  exit

}

uninstall () {
   plat=`uname`
  case $plat in
    Linux)
      rm /usr/share/xsessions/nwm.desktop
    ;;
  esac
  exit

}

xephyr () {
  #the default size is small, so you can see loggers, etc.
  if [ "x$1" = x ]; then
    size=800x600
  else
    size="$1"
  fi
  Xephyr -screen "$size" -nodri -br :1 &
  DISPLAY=:1 start --nolog
}

help () {
  less $dir/readme.md
}

$@

echo 'USAGE: nwm start|install|uninstall|help'
exit 1
